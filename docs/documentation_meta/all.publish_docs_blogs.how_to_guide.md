<!-- toc -->

- [Publishing Docs & Blogs with Mkdocs — Causify/Umd Classes Playbook](#publishing-docs--blogs-with-mkdocs--causifyumd-classes-playbook)
  * [Concepts at a Glance](#concepts-at-a-glance)
  * [Directory Structure (Invariants)](#directory-structure-invariants)
  * [Canonical Assets & CSS](#canonical-assets--css)
  * [`mkdocs.yml` Templates](#mkdocsyml-templates)
  * [Blog Template](#blog-template)
  * [Preprocess → Preview Locally](#preprocess-%E2%86%92-preview-locally)
  * [Publish to Github Pages (Manual, One-Off)](#publish-to-github-pages-manual-one-off)
  * [Add Github Action to Update/ Push Site When Changes in Docs](#add-github-action-to-update-push-site-when-changes-in-docs)
  * [Per-Repo Examples](#per-repo-examples)
    + [`Tutorials`](#tutorials)
    + [`umd_clases`](#umd_clases)
  * [Redirects & Cleanup](#redirects--cleanup)
  * [Troubleshooting](#troubleshooting)
  * [Quick Checklists](#quick-checklists)

<!-- tocstop -->

# Summary

This document covers how to publish documents, books, and blogs across different
repos (e.g., `//helpers`, `//csfy`, `//tutorials`, and `//umd_classes`.

# Publishing Docs & Blogs with Mkdocs

## Concepts at a Glance

- The content to publish is organized under directories like
  - `docs/`
  - `blog/`
  - `mkdocs/`
- `preprocess.py` preprocesses Markdown into `tmp.mkdocs/` using our helper
  script (cleans ToCs, normalizes code fences, etc.).
- `mkdocs.yml` points `docs_dir: tmp.mkdocs` so builds use the preprocessed
  files.
- Assets & CSS are symlinked (preferred) or copied from canonical files so all
  sites look the same.
- We publish with either:
  - GitHub Pages (`gh-pages` branch) for websites, or
  - S3 (for some blogs), or
  - GitHub Actions that build and push to Pages.

## Directory Structure (Invariants)

- Every site we publish must follow the same dir / file layout:
  ```pgsql
  <site-root>/
    mkdocs.yml                # site config (docs_dir points to tmp.mkdocs)
    docs/                     # raw content (source)
      index.md
      <other .md files and folders>
      assets/                 # logo.png, favicon.ico (symlinks or real files)
      styles/                 # styles.css (symlink or real)
    tmp.mkdocs/               # generated by preprocess (DO NOT COMMIT)
  ```

- Invariants
  - All documents reuse the same `mkdocs.yml` template (only `site_name` etc.
    change).
  - All blogs reuse the same `mkdocs.yml` (plus the blog plugin).
  - Only two GitHub workflows: one for documents, one for blogs (same logic;
    small variations).
  - Assets/CSS shared across repos should be symlinked to a single canonical
    copy so there’s only one source of truth.

## Canonical Assets & CSS

- We keep the "master look & feel" here (examples):
  ```bash
  helpers_root/docs/mkdocs/assets/logo.png
  helpers_root/docs/mkdocs/assets/favicon.ico
  helpers_root/docs/mkdocs/styles/styles.css
  ```

- In a site (e.g., `data605_book` present in tutorials repo), symlink them rather
  than copying the entire file:
  ```bash
  > mkdir -p mkdocs/docs/assets mkdocs/docs/styles

  # Find Helpers Path (Submodule or Sibling).
  > ROOT=$(git rev-parse --show-toplevel)
  > if [ -d "$ROOT/helpers_root" ]; then HEL="$ROOT/helpers_root"
    elif [ -d "$ROOT/helpers" ]; then HEL="$ROOT/helpers"
    else echo "No helpers{,_root} found"; exit 1; fi

  > ln -snf "$HEL/docs/mkdocs/assets/logo.png" mkdocs/docs/assets/logo.png
  > ln -snf "$HEL/docs/mkdocs/assets/favicon.ico" mkdocs/docs/assets/favicon.ico
  > ln -snf "$HEL/docs/mkdocs/styles/styles.css" mkdocs/docs/styles/styles.css
  ```

- IMPORTANT: Our preprocess script dereferences symlinks (uses `cp -rL`), so the
  output in `tmp.mkdocs/` contains real files that MkDocs can copy during build.

## `mkdocs.yml` Templates

- Template at - [/docs/mkdocs/mkdocs.yml](/docs/mkdocs/mkdocs.yml)
- Following is an exammple template that might update as we improve
  ```yml
  site_name: Your Site Name
  theme:
    name: material
    palette:
      primary: black
      accent: cyan
    logo: assets/logo.png
    favicon: assets/favicon.ico
    features:
      - content.action.edit
  docs_dir: tmp.mkdocs
  use_directory_urls: false
  plugins:
    - search
  markdown_extensions:
    - toc:
        permalink: "#"
        baselevel: 2
        separator: "_"
  extra_css:
    - styles/styles.css
  ```

## Blog Template

- Template at 
  [Blogs Template](https://github.com/causify-ai/tutorials/blob/master/blog/mkdocs.yml)
- Following is an example template that might update as we improve
  ```yml
  site_name: Your Blog
  theme:
    name: material
    palette:
      primary: black
      accent: cyan
    logo: assets/logo.png
    favicon: assets/favicon.ico
    features:
      - navigation.indexes
  use_directory_urls: false
  nav:
    - Blog:
        - index.md
  plugins:
    - search
    - blog:
        enabled: true
        blog_dir: .
        blog_toc: true
        post_date_format: full
        post_url_date_format: yyyy/MM/dd
        post_excerpt_separator: <!-- more -->
        pagination: false
        pagination_per_page: 1
        pagination_keep_content: true
  markdown_extensions:
    - toc:
        permalink: "#"
        baselevel: 2
        separator: "_"
    - pymdownx.superfences:
        custom_fences:
          - name: mermaid
            class: mermaid
            format: !!python/name:pymdownx.superfences.fence_code_format
  extra_css:
    - styles/styles.css
  ```

## Preprocess → Preview Locally

- From the site directory:
  ```bash
  # Preprocess: Copy Docs -> Tmp.Mkdocs (Resolving Symlinks) & Transform Markdown.
  > python ../helpers_root/docs/mkdocs/preprocess_mkdocs.py \
    --input_dir mkdocs/docs \
    --output_dir tmp.mkdocs \
    -v INFO

  # Activate Env.
  > source "$HOME/src/venv/mkdocs/bin/activate"

  # Serve Locally.
  > mkdocs serve -f mkdocs.yml -a 127.0.0.1:8000

  # Visit Http://127.0.0.1:8000/
  ```

- If you see 404 at /:
  - Ensure there is an `index.md` in raw content (e.g., `mkdocs/docs/index.md`).
  - Ensure `docs_dir: tmp.mkdocs` in `mkdocs.yml`.
  - Confirm `tmp.mkdocs/index.md` exists after preprocess.

## Publish to Github Pages (Manual, One-Off)

- Use this when testing or before your Actions are in place.
  ```bash
  # Build Into a Staging Folder Inside the Repo.
  mkdocs build -f mkdocs.yml --site-dir ../_site/book.data605

  # Prepare Gh-Pages Worktree in Repo Root.
  cd ..
  git fetch origin

  # Clean Out Any Old Worktree.
  git worktree remove --force .ghpages-pub 2>/dev/null || true
  rm -rf .ghpages-pub
  git worktree prune

  # Create Fresh Worktree.
  git worktree add -B gh-pages .ghpages-pub origin/gh-pages || \
  git worktree add -B gh-pages .ghpages-pub

  # Sync Only Your Book Folder (Exclude Overly Large Files If Hooks Block Them).
  rsync -a --delete \
    --exclude '*.map' \
    --exclude 'assets/javascripts/lunr/wordcut.js' \
    _site/book.data605/ .ghpages-pub/book.data605/

  # Ensure Pages Doesn'T Run Jekyll on Our Output.
  touch .ghpages-pub/.nojekyll

  # Commit & Push.
  cd .ghpages-pub
  git add -A
  git commit -m "Publish site (manual)"
  git push origin gh-pages
  ```

- GitHub Pages settings (one-time):
  - Repo → Settings → Pages → Build and deployment:
  - Source: Deploy from a branch
  - Branch: gh-pages and Folder: / (root)
  - Give it ~1 minute, then open:
    - Https://<org_or_user>.github.io/<repo>/<site-subpath>/

## Add Github Action to Update / Push Site When Changes in Docs

- We publish automatically via a GitHub Actions workflow

- Once set up:
  - Trigger: Any commit that touches your content paths (e.g.,
    notes.programming_with_ai/**, notes.startup_admin_guide/**, or shared
    assets/styles) will trigger the workflow.
  - Build: The workflow:
    - Checks out the repo
    - Installs MkDocs + plugins
    - Runs our preprocessor to generate `tmp.mkdocs/` (dereferencing symlinks)
    - Runs `mkdocs build` to produce the static site in `_site/...`.
  - Deploy: The workflow uploads the `_site/` artifact and deploys it to GitHub
    Pages (`gh-pages`), updating the live site automatically.
  - Optional schedule: You can also enable a nightly cron to rebuild even if there
    were no commits (useful if you have external includes or shared assets).
  - No secrets needed: Pages deploy uses GitHub’s built-in token. Ensure the
    workflow has permissions: `contents: write`, `pages: write`, and
    `id-token: write`.

- One-time setup
  - Enable Pages: Repo → Settings → Pages → Deploy from a branch → Branch:
    gh-pages, Folder: / (root).
  - Add the workflow: Copy our template from
    `//.github/workflows/publish_mkdocs.yml` (see template link below).
  - Adjust paths: In the workflow, list the folders that should trigger a rebuild
    under on.push.paths (e.g., your book/blog directories and shared
    assets/styles).
  - Verify mkdocs.yml: Each site uses docs_dir: tmp.mkdocs and references assets/
    & styles/ (which are symlinked in the raw docs/ tree).
  - Commit to main: Push a change under a watched path and confirm the workflow
    publishes.
  - Template: See TEMPLATE: `.github/workflows/publish_mkdocs.yml` in this repo
    for the exact workflow

## Per-Repo Examples

### `//tutorials`

- `notes.programming_with_ai/`
- `notes.startup_admin_guide/`

- Each has:
  ```pgsql
  mkdocs.yml
  docs/
    index.md
    assets/ (symlinks)
    styles/ (symlink styles.css)
  tmp.mkdocs/ (generated)
  ```

- Published to:
  - [](https://causify-ai.github.io/tutorials/books/notes.programming_with_ai/)
  - [](https://causify-ai.github.io/tutorials/books/notes.startup_admin_guide/)
  ```

### `//umd_classes`

- `data605_book/`
- `msml610_book/`

- Published to:
  - [](https://gpsaggese.github.io/umd_classes/book.data605/)
  - [](https://gpsaggese.github.io/umd_classes/book.msml610/)

- Root page can link to each: `index.html` in `gh-pages` with simple `<a>` links.

## Redirects & Cleanup

- To retire an old path, add an index.html that meta-redirects:
  ```html
  <meta http-equiv="refresh" content="0; url=/<repo>/<new-path>/" />
  ```
- To disable a Pages site entirely: `Settings` → `Pages` → `Source`: `Disabled`.
- To remove old content: delete the folder from the `gh-pages` worktree, commit,
  push.

## Troubleshooting

- 404 at `/` while serving locally: - `tmp.mkdocs/index.md` missing → rerun
  preprocess or create `mkdocs/docs/index.md`. - `docs_dir` misconfigured →
  ensure `docs_dir: tmp.mkdocs`. -Assets 404 (logo/favicon/css): - Ensure
  symlinks exist and point to real files (`ls -lL` to follow links). - Rerun
  preprocess (it resolves symlinks into real files under `tmp.mkdocs/`).
- Preprocess fails with cyclic links:
  - Do not symlink mkdocs/docs back into itself. Keep `mkdocs/docs` pointing to
    real content; only individual files under it may be symlinks to canonical
    assets.
- Git hooks block large files:
  - Exclude `*.map` and large vendor files when rsyncing to the `gh-pages`
    worktree.
- Pages shows "There isn’t a GitHub Pages site here."
  - Enable `Pages`: `Settings` → `Pages` → `Deploy` from a branch →
    `gh-pages / root`.
  - Push to `gh-pages` and wait ~1 minute; hard refresh.

## Quick Checklists

- New document/book
  - Create `mkdocs.yml` from the document template.
  - Create `docs/` with `index.md`.
  - Symlink `docs/assets/{logo.png,favicon.ico}` & `docs/styles/styles.css` to
    canonical copies (if needed).
  - Preprocess → `tmp.mkdocs/`.
  - Preview: `mkdocs serve -f mkdocs.yml -a 127.0.0.1:8000`.
  - Publish via Actions or manual worktree.
- New blog
  - Create `mkdocs.yml` from the blog template.
  - Place posts under `blog/docs/` (or the configured `blog_dir`).
  - Symlink `assets/styles` (if using the same images/ style files).
  - Build/preview/publish (to S3 or Pages).
