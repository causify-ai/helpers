

<!-- toc -->

- [Code organization](#code-organization)

<!-- tocstop -->

# Code organization

- Each directory that is "releasable" (e.g., `orange`, `amp`, `optimizer`), i.e.,
  that can build a Docker container and run inside it has:
  - `changelog.txt`: store the changelog
  - `devops`: dir with all the Docker files needed to build and run a container

- There are several types of `devops` dirs
  - A `devops` where a container is built, run, and released
    - E.g., `amp`, `helpers`, `optimizer`
  - A `devops` where a container from a different dir is run
    - E.g., `orange`, `sports_analytics`, `tutorials`, `demo`

## Devops to build, release, run a container

- An example of the `devops` structure is:
  ```
  > cd //amp
  > tree.sh -p devops
  devops/
  |-- compose/
  |   `-- __init__.py
  |-- debug/
  |   `-- repo_compare.sh*
  |-- docker_build/
  |   |-- create_users.sh*
  |   |-- dev.Dockerfile
  |   |-- etc_sudoers
  |   |-- fstab
  |   |-- install_cprofile.sh
  |   |-- install_dind.sh*
  |   |-- install_jupyter_extensions.sh*
  |   |-- install_os_packages.sh*
  |   |-- install_python_packages.sh*
  |   |-- poetry.lock
  |   |-- poetry.toml
  |   |-- prod.Dockerfile
  |   `-- pyproject.toml
  |-- docker_run/
  |   |-- aws_credentials.sh
  |   |-- bashrc
  |   |-- entrypoint.sh*
  |   |-- run_jupyter_server.sh*
  |   |-- setenv.sh
  |   `-- test_setup.sh*
  |-- env/
  |   `-- default.env
  |-- notebooks/
  ...
  |-- test/
  ...
  `-- __init__.py
  ```

- The organization of a `devops` dir is:
  - `compose`: Docker compose files
  - `docker_build`: everything related to building a Docker image
  - `docker_run`: everything related to running a Docker image
  - `env`: Docker env files

- Optional dirs are:
  - `debug`: scripts to debug and maintain the dir
  - `notebooks`: notebooks used to analyze, monitor Docker container
    - E.g., `Master_buildmeister_dashboard.ipynb`
  - `test`: everything needed to test a Docker image

## Detail description of files
- In `devops/compose/`
    - `devops/compose/docker-compose.yml`: file generated by the `invoke` system
      based on templates, to run a Docker compose

- In `devops/docker_build/`
  - `create_users.sh`: create the needed users inside the container
  - `dev.Dockerfile`: Dockerfile to build the dev version of the container
  - `etc_sudoers`: give sudo permission to all users inside the container
  - `fstab`: mount S3 and other dir in the container
    - TODO(gp): Not sure if it's needed anymore
  - `install_cprofile.sh`: install the packages needed to profile Python code
    inside the repo
  - `install_dind.sh`: install docker-in-docker
    - This workflow has been superseded by Docker sibling approach
  - `install_jupyter_extensions.sh`: install Jupyter
  - `install_os_packages.sh`: install the OS packages
  - `install_python_packages.sh`: install the Python packages with `poetry` and
    `pip`
  - `poetry.lock`: file generated by `poetry` after the list of packages has been
    generated
    - This tracks what packages were installed by `poetry`
  - `poetry.toml`: configuration file for `poetry`
  - `prod.Dockerfile`: Dockerfile to build the prod version of the container
  - `pyproject.toml`: list of package specification for `poetry`

- In `devops/docker_run/`
  - `aws_credentials.sh`: loads the AWS credentials in the corresponding env vars
    - TODO(gp): This seems useless
  - `bashrc`: basic configuration for bash shells inside a container
  - `entrypoint.sh`: configures the container on startup
    - E.g., run `setenv.sh`, start dind, setup Git to run inside the container
  - `run_jupyter_server.sh`: start Jupyter notebook
  - `setenv.sh`: configure the virtual environment inside the container
    - E.g., update `$PATH` and `$PYTHONPATH`
    - This is equivalent to `setenv.sh` for the thin environment
  - `test_setup.sh`: check that the major systems are configured properly
    - E.g., `AWS`, `gspread`, ...
    - TODO(gp): Probably obsolete

- In `env/`
  - `default.env`: set some variables and their defaults
    - TODO(gp): This seems useless

## Devops to run an already existing container

- To reuse a Docker container from a different dir / repo, `devops` doesn't need
  `docker_build` dir
  ```bash
  > tree.sh -p devops
  devops/
  |-- debug/
  |   `-- repo_compare.sh*
  |-- docker_build/
  |   `-- prod.Dockerfile -> ../../amp/devops/docker_build/prod.Dockerfile
  |-- docker_run/
  |   |-- aws_credentials.sh
  |   |-- bashrc
  |   |-- entrypoint.sh*
  |   |-- run_jupyter_server.sh*
  |   |-- setenv.sh
  |   `-- test_setup.sh*
  `-- env/
      `-- default.env
  ```
